<UserControl
        xmlns:p="clr-namespace:OSEMAddIn.Properties" x:Class="OSEMAddIn.Views.EventDetail.EventDetailView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:conv="clr-namespace:OSEMAddIn.Converters"
             mc:Ignorable="d">
        <UserControl.Resources>
        <conv:BusyStateConverter x:Key="BusyStateConverter" />
        <conv:FilePathToNameConverter x:Key="FilePathToNameConverter" />
        <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter" />
    </UserControl.Resources>
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <DockPanel Grid.Row="0" Margin="0 0 0 8">
            <Button Content="{x:Static p:Resources.Back_to_List}" Command="{Binding BackCommand}" />
            <StackPanel Margin="12 0 0 0">
                <TextBox x:Name="TitleTextBox"
                         Text="{Binding EventTitle, UpdateSourceTrigger=LostFocus}"
                         FontSize="16"
                         FontWeight="Bold" />
                <StackPanel Orientation="Horizontal" Margin="0 4 0 0">
                    <TextBlock Text="{Binding EventId, StringFormat=ID: {0}}" Foreground="Gray" Margin="0 0 12 0" VerticalAlignment="Center"/>
                    <TextBlock Text="{Binding Status, StringFormat={x:Static p:Resources.Binding_Status_StringFormat_Status_0}}" Foreground="Gray" VerticalAlignment="Center" Margin="0 0 12 0"/>
                    <Button Content="{x:Static p:Resources.Archive_Event}" Command="{Binding ArchiveCommand}" Background="#FFEF5350" Foreground="White" Padding="8,2" VerticalAlignment="Center">
                        <Button.Style>
                            <Style TargetType="Button">
                                <Setter Property="Visibility" Value="Visible"/>
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding IsEnabled, RelativeSource={RelativeSource Self}}" Value="False">
                                        <Setter Property="Visibility" Value="Collapsed"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </Button.Style>
                    </Button>
                    <Button Content="{x:Static p:Resources.Reopen}" Command="{Binding ReopenCommand}" Background="#FF4CAF50" Foreground="White" Padding="8,2" VerticalAlignment="Center" Margin="8,0,0,0">
                        <Button.Style>
                            <Style TargetType="Button">
                                <Setter Property="Visibility" Value="Visible"/>
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding IsEnabled, RelativeSource={RelativeSource Self}}" Value="False">
                                        <Setter Property="Visibility" Value="Collapsed"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </Button.Style>
                    </Button>
                </StackPanel>
            </StackPanel>
        </DockPanel>

        <ToolBarTray Grid.Row="1" Orientation="Horizontal" IsLocked="True">
            <ToolBar Band="0" BandIndex="0">
                <TextBlock Text="{x:Static p:Resources.Event_Template}" VerticalAlignment="Center" Margin="0,0,4,0"/>
                <ComboBox Width="160" ItemsSource="{Binding DashboardTemplates}"
                          DisplayMemberPath="DisplayName"
                          SelectedItem="{Binding SelectedTemplate}"
                          ToolTip="选择模板" />
                <TextBlock Text="Info:" VerticalAlignment="Center" Margin="8,0,4,0"/>
                <ComboBox Width="200" ItemsSource="{Binding AvailableDisplaySources}"
                          Text="{Binding DisplayColumnSource, UpdateSourceTrigger=PropertyChanged, Delay=300}"
                          IsEditable="True"
                          ToolTip="{x:Static p:Resources.Select_columns_to_display_or_enter_custom_content}" />
                <TextBox Width="150" Text="{Binding DisplayColumnCustomValue, UpdateSourceTrigger=PropertyChanged, Delay=300}"
                         Visibility="{Binding IsCustomDisplayColumn, Converter={StaticResource BooleanToVisibilityConverter}}"
                         Margin="4,0,0,0"
                         VerticalContentAlignment="Center"
                         ToolTip="{x:Static p:Resources.Enter_custom_Info_content}" />
            </ToolBar>
        </ToolBarTray>

        <Grid Grid.Row="2">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="2*" />
                <ColumnDefinition Width="5" />
                <ColumnDefinition Width="3*" />
                <ColumnDefinition Width="5" />
                <ColumnDefinition Width="2*" />
            </Grid.ColumnDefinitions>

            <Grid Grid.Column="0" Margin="0 0 8 0">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="*" />
                </Grid.RowDefinitions>

                <StackPanel Grid.Row="0" Margin="0 0 0 8">
                    <TextBlock Text="Prompt:" FontWeight="Bold" Margin="0 0 0 4"/>
                    <ComboBox ItemsSource="{Binding Path=Prompts}" DisplayMemberPath="DisplayName" SelectedItem="{Binding SelectedPrompt}" Margin="0 0 0 4"/>
                    <Button Content="{x:Static p:Resources.Run_LLM_Extraction}" Command="{Binding ExtractViaLlmCommand}" Margin="0 0 0 8"/>

                    <TextBlock Text="{x:Static p:Resources.Regex_Extraction}" FontWeight="Bold" Margin="0 0 0 4"/>
                    <Button Content="{x:Static p:Resources.Run_Regex_Extraction}" Command="{Binding ExtractViaRegexCommand}" Margin="0 0 0 8"/>

                    <TextBlock Text="{x:Static p:Resources.Script}" FontWeight="Bold" Margin="0 0 0 4"/>
                    <ComboBox ItemsSource="{Binding PythonScripts}" DisplayMemberPath="DisplayName" SelectedItem="{Binding SelectedScript}" Margin="0 0 0 4"/>
                    <Button Content="{x:Static p:Resources.Run_Script}" Command="{Binding ExecutePythonScriptCommand}" Margin="0 0 0 8"/>

                    <TextBlock Text="JsonKeyText:" FontWeight="Bold" Margin="0 0 0 4"/>
                    <Button Content="{x:Static p:Resources.Copy}" Command="{Binding CopyJsonKeysCommand}" Margin="0 0 0 8"/>
                    
                    <Separator Margin="0 0 0 8"/>
                </StackPanel>

                <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
                    <ItemsControl ItemsSource="{Binding DashboardItems}">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <StackPanel Margin="0 0 0 8">
                                    <TextBlock Text="{Binding Key}" FontWeight="Bold" />
                                    <TextBox Text="{Binding Value, UpdateSourceTrigger=LostFocus}" />
                                </StackPanel>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </ScrollViewer>
            </Grid>

            <GridSplitter Grid.Column="1" Width="5" HorizontalAlignment="Stretch" />

            <Grid Grid.Column="2">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="*" />
                </Grid.RowDefinitions>
        <StackPanel Orientation="Horizontal" Margin="0 0 0 8">
            <TextBlock Text="{x:Static p:Resources.Email_Pool}" FontSize="14" FontWeight="Bold" VerticalAlignment="Center" />
            <StackPanel Orientation="Horizontal" Margin="16 0 0 0">
                <Button Content="{x:Static p:Resources.Refresh_Emails}"
                        Command="{Binding RefreshMailCommand}"
                        Padding="10,2" 
                        Margin="0,0,1,0"/>
                <Button Content="▼" 
                        Padding="2,2" 
                        Margin="0"
                        Width="20"
                        Click="RangeButton_Click">
                    <Button.ContextMenu>
                        <ContextMenu>
                            <MenuItem Header="{x:Static p:Resources.Res_30_Days_Default}" IsCheckable="True" IsChecked="{Binding IsRange30Days, Mode=OneWay}" Command="{Binding SetSubjectSearchRangeCommand}" CommandParameter="30" />
                            <MenuItem Header="{x:Static p:Resources.Res_45_Days}" IsCheckable="True" IsChecked="{Binding IsRange45Days, Mode=OneWay}" Command="{Binding SetSubjectSearchRangeCommand}" CommandParameter="45" />
                            <MenuItem Header="{x:Static p:Resources.Res_60_Days}" IsCheckable="True" IsChecked="{Binding IsRange60Days, Mode=OneWay}" Command="{Binding SetSubjectSearchRangeCommand}" CommandParameter="60" />
                            <MenuItem Header="{x:Static p:Resources.Res_180_Days}" IsCheckable="True" IsChecked="{Binding IsRange180Days, Mode=OneWay}" Command="{Binding SetSubjectSearchRangeCommand}" CommandParameter="180" />
                            <MenuItem Header="{x:Static p:Resources.All_10_Years}" IsCheckable="True" IsChecked="{Binding IsRangeAll, Mode=OneWay}" Command="{Binding SetSubjectSearchRangeCommand}" CommandParameter="3650" />
                        </ContextMenu>
                    </Button.ContextMenu>
                </Button>
            </StackPanel>
            <Button Content="{x:Static p:Resources.Remove_Selected}"
                Command="{Binding RemoveMailCommand}"
                CommandParameter="{Binding SelectedMail}"
                Margin="8 0 0 0" />
            <Button Content="{x:Static p:Resources.Mark_All_Read}"
                Command="{Binding MarkAllAsReadCommand}"
                Margin="8 0 0 0" />
        </StackPanel>
                <DataGrid Grid.Row="1"
                          ItemsSource="{Binding MailItems}"
                          SelectedItem="{Binding SelectedMail, Mode=TwoWay}"
                          AutoGenerateColumns="False"
                          MouseDoubleClick="MailGrid_OnMouseDoubleClick"
                          AllowDrop="True"
                          DragOver="MailGrid_OnDragOver"
                          Drop="MailGrid_OnDrop"
                          IsReadOnly="True"
                          ScrollViewer.CanContentScroll="True"
                          ScrollViewer.VerticalScrollBarVisibility="Auto"
                          ScrollViewer.HorizontalScrollBarVisibility="Auto">
                    <DataGrid.Resources>
                        <Style TargetType="DataGridRow">
                            <Setter Property="FontWeight" Value="Normal" />
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding IsNewOrUpdated}" Value="True">
                                    <Setter Property="FontWeight" Value="Bold" />
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </DataGrid.Resources>
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="发件人" Binding="{Binding Sender}" Width="*" />
                        <DataGridTextColumn Header="{x:Static p:Resources.Recipient}" Binding="{Binding To}" Width="*" />
                        <DataGridTextColumn Header="{x:Static p:Resources.Subject}" Binding="{Binding Subject}" Width="2*" />
                        <DataGridTextColumn Header="{x:Static p:Resources.Received_Time}" Binding="{Binding ReceivedOn, StringFormat=yyyy-MM-dd HH:mm}" Width="*" />
                    </DataGrid.Columns>
                    <DataGrid.ContextMenu>
                        <ContextMenu DataContext="{Binding PlacementTarget.DataContext, RelativeSource={RelativeSource Self}}">
                            <MenuItem Header="{x:Static p:Resources.Remove_this_email}" Command="{Binding RemoveMailCommand}" CommandParameter="{Binding PlacementTarget.SelectedItem, RelativeSource={RelativeSource AncestorType=ContextMenu}}" />
                        </ContextMenu>
                    </DataGrid.ContextMenu>
                </DataGrid>
            </Grid>

            <GridSplitter Grid.Column="3" Width="5" HorizontalAlignment="Stretch" />

            <Grid Grid.Column="4">
                <Grid.RowDefinitions>
                    <RowDefinition Height="*" />
                    <RowDefinition Height="5" />
                    <RowDefinition Height="*" />
                </Grid.RowDefinitions>

                <Grid Grid.Row="0">
                    <TextBlock Text="{x:Static p:Resources.Attachments}" FontSize="14" FontWeight="Bold" Margin="0 0 0 8" />
                    <ListView ItemsSource="{Binding Attachments}" 
                              Margin="0 24 0 0"
                              MouseDoubleClick="AttachmentList_OnMouseDoubleClick"
                              PreviewMouseLeftButtonDown="AttachmentList_OnPreviewMouseLeftButtonDown"
                              PreviewMouseLeftButtonUp="AttachmentList_OnPreviewMouseLeftButtonUp"
                              MouseMove="AttachmentList_OnMouseMove">
                        <ListView.View>
                            <GridView>
                                <GridViewColumn Header="{x:Static p:Resources.Filename}" DisplayMemberBinding="{Binding FileName}" Width="180" />
                                <GridViewColumn Header="{x:Static p:Resources.Received_Time_1}" DisplayMemberBinding="{Binding ReceivedOn, StringFormat=yyyy-MM-dd HH:mm}" Width="110" />
                                <GridViewColumn Header="发件人" DisplayMemberBinding="{Binding Sender}" Width="100" />
                                <GridViewColumn Header="{x:Static p:Resources.Email_Name}" DisplayMemberBinding="{Binding Subject}" Width="150" />
                                <GridViewColumn Header="{x:Static p:Resources.Size}" DisplayMemberBinding="{Binding FileSizeBytes}" Width="80" />
                            </GridView>
                        </ListView.View>
                    </ListView>
                </Grid>

                <GridSplitter Grid.Row="1" Height="5" HorizontalAlignment="Stretch" />

                <Grid Grid.Row="2">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                        <RowDefinition Height="Auto" />
                    </Grid.RowDefinitions>
                    <TextBlock Grid.Row="0" Text="{x:Static p:Resources.File_Area}" FontSize="14" FontWeight="Bold" Margin="0 0 0 8" />
                    <ListView Grid.Row="1" 
                              ItemsSource="{Binding TemplateFiles}" 
                              MouseDoubleClick="TemplateFileList_OnMouseDoubleClick"
                              PreviewMouseLeftButtonDown="TemplateFileList_OnPreviewMouseLeftButtonDown"
                              PreviewMouseLeftButtonUp="TemplateFileList_OnPreviewMouseLeftButtonUp"
                              MouseMove="TemplateFileList_OnMouseMove"
                              AllowDrop="True"
                              Drop="TemplateFileList_OnDrop"
                              Background="Transparent"
                              ScrollViewer.VerticalScrollBarVisibility="Auto"
                              SelectionMode="Extended">
                        <ListView.InputBindings>
                            <KeyBinding Key="Delete" Command="{Binding RemoveTemplateFileCommand}" CommandParameter="{Binding RelativeSource={RelativeSource FindAncestor, AncestorType=ListView}, Path=SelectedItems}" />
                        </ListView.InputBindings>
                        <ListView.ContextMenu>
                            <ContextMenu>
                                <MenuItem Header="{x:Static p:Resources.Delete}" Command="{Binding RemoveTemplateFileCommand}" CommandParameter="{Binding PlacementTarget.SelectedItems, RelativeSource={RelativeSource FindAncestor, AncestorType=ContextMenu}}" />
                            </ContextMenu>
                        </ListView.ContextMenu>
                        <ListView.View>
                            <GridView>
                                <GridViewColumn Header="{x:Static p:Resources.Filename}" DisplayMemberBinding="{Binding FileName}" Width="180" />
                                <GridViewColumn Header="{x:Static p:Resources.Path}" DisplayMemberBinding="{Binding FilePath}" Width="200" />
                            </GridView>
                        </ListView.View>
                    </ListView>
                    <StackPanel Grid.Row="2" Orientation="Horizontal" HorizontalAlignment="Right" Margin="0 8 0 0">
                        <Button Content="{x:Static p:Resources.Generate_Folder}" Command="{Binding GenerateFolderCommand}" Margin="0 0 8 0" Padding="8,2"/>
                        <Button Content="{x:Static p:Resources.Update_to_Folder}" Command="{Binding UpdateFolderCommand}" Padding="8,2"/>
                    </StackPanel>
                </Grid>
            </Grid>
        </Grid>

        <StatusBar Grid.Row="3" Margin="0 8 0 0">
            <StatusBarItem>
                <TextBlock Text="{Binding StatusMessage}" />
            </StatusBarItem>
            <StatusBarItem HorizontalAlignment="Right">
                <ProgressBar Width="150" Height="12" 
                             Value="{Binding ProgressValue}" 
                             IsIndeterminate="{Binding IsProgressIndeterminate}"
                             Visibility="{Binding IsBusy, Converter={StaticResource BooleanToVisibilityConverter}}" />
            </StatusBarItem>
        </StatusBar>
    </Grid>
</UserControl>
