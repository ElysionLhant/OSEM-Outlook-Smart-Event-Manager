# OSEM (Outlook Smart Event Manager) 用户指南

## 简介
OSEM (Outlook Smart Event Manager) 是一款专为 Microsoft Outlook 设计的强大 VSTO 插件，旨在简化基于事件的邮件管理。它将您的收件箱转化为结构化的事件跟踪系统，允许您对相关邮件进行分组，使用 LLM（大语言模型）或正则表达式提取关键信息，并通过 Python 脚本自动化工作流程。

**核心功能：**
*   **以事件为中心的视图：** 根据主题模式自动将相关邮件分组为“事件”。
*   **智能提取：** 使用本地 LLM（通过 Ollama）或正则表达式从邮件正文中提取结构化数据（仪表盘）。
*   **模板系统：** 为不同类型的工作流（如物流、销售）定义自定义数据结构（仪表盘）和邮件模板。
*   **脚本自动化：** 运行外部 Python 脚本来处理事件数据和附件。
*   **报表导出：** 支持将事件数据、附件和文件导出到本地文件夹，便于归档和报告。
*   **本地化：** 完全支持英语和简体中文（自动检测系统语言）。

---

## 安装与设置
1.  **前提条件：**
    *   Microsoft Outlook (桌面版)。
    *   .NET Framework 4.8 或更高版本。
    *   (可选) [Ollama](https://ollama.com/) 用于本地 LLM 功能。
    *   (可选) Python 环境用于脚本功能。
2.  **安装：**
    *   **普通用户：** 运行发布包中的 `setup.exe`。
    *   **开发者：** 在 Visual Studio 中打开 `OSEMAddIn.sln`，编译并运行 (F5)。
    *   打开 Outlook。您应该能在功能区或新的任务窗格中看到“Event Manager”按钮。
3.  **卸载：**
    *   打开 Windows **设置** > **应用** > **安装的应用**。
    *   搜索 "OSEM"。
    *   点击右侧的三个点菜单，选择 **卸载**。

---

## 使用建议 (Usage Tips)
由于本插件深度集成于 Outlook 运行环境，建议您在 Outlook 启动初期（尤其是周一早晨处理大量邮件同步时）预留 1-2 分钟的缓冲时间，待 Outlook 完成基础的初始化与数据同步后再进行操作。

尽管插件已针对主线程性能进行了优化与避让，但 Outlook 的主 UI 线程在处理高负载任务时较为敏感。在 Outlook 界面响应完全流畅之前，请尽量避免快速连续点击或执行复杂操作，以防止因 UI 渲染阻塞导致界面暂时挂起。

此外，请注意 Outlook 的响应速度可能会比平时略有下降，具体程度取决于您的硬件规格和内存情况。

---

## 主界面：事件管理器 (Event Manager)
**事件管理器** 是跟踪活动工作流的中心枢纽。

### 1. 事件列表
*   **进行中的事件 (Active Events)：** 显示当前打开的事件。
    *   **列：** 事件标题、最后更新时间、Info（自定义摘要）、优先级（星形图标）。
    *   **操作：**
        *   **创建事件 (拖拽)：** 直接从 Outlook 邮件列表中拖拽**一封**邮件到此列表区域，即可一键生成新事件。
        *   **双击：** 打开 **事件详情视图 (Event Detail View)**。
        *   **右键：** 重命名、归档或删除事件的选项。
        *   **切换优先级：** 点击星形图标标记重要事件。
*   **已完结的事件 (Completed Events)：** 显示已归档的事件。您可以从此处重新打开它们。

### 2. 工具栏控件
*   **搜索：** 按标题或内容筛选事件。
*   **筛选模板：** 仅显示与特定模板关联的事件。
*   **全部刷新：** 从受监控的文件夹重新加载所有事件。
*   **模板规则：** 配置基于邮件参与者的模板自动分配规则。
*   **模板编辑器：** 打开配置中心（模板、Prompt、脚本）。
*   **完结选中项：** 归档选中的事件。
*   **执行脚本：** 对选中的事件执行全局 Python 脚本。
*   **导出：** 打开导出选项窗口，批量导出事件数据。

---

## 事件详情视图 (Event Detail View)
双击事件可打开 **事件详情视图**，您可以在此处处理具体任务。

### 1. 仪表盘 (左侧面板)
*   **状态：** 显示事件的当前状态。
*   **模板：** 选择此事件的数据结构（模板）。
*   **Info 字段：** 显示在事件详情中的关键信息键值对，支持手动编辑与修改。
    *   **执行 LLM 提取：** 点击 **"执行 LLM 提取"** 使用 AI 根据选中的邮件自动填充这些字段。
    *   **执行正则提取：** 点击 **"执行正则提取"** 使用预定义的模式。
    *   **复制：** 一键将当前非空的字段以 JSON 格式复制到剪贴板，方便粘贴到其他系统。

### 2. 邮件池 (中间面板)
*   显示该事件下的所有邮件。
*   **操作：**
    *   **添加邮件 (拖拽)：** 直接从 Outlook 拖拽**一封或多封**邮件到此区域，即可将其一键添加到当前事件中。
    *   **刷新邮件：** 自动检索并添加与当前邮件池中邮件属于同一会话（Conversation）的所有相关邮件，方便获取完整的上下文和附件。
    *   **选择与预览：** 点击邮件将其作为提取源。当邮件预览窗格生效时，单击邮件池中的邮件即可直接预览邮件内容。
    *   **移除：** 从此事件中移除不相关的邮件。
    *   **一键已读：** 将选中的邮件标记为已读。

### 3. 附件与文件 (右侧面板)
*   **附件：** 列出事件邮件中发现的所有附件。
*   **文件区：** 此事件专用的本地文件夹（每个事件独立）。
    *   **交互：** 支持直接从“附件”列表、桌面或文件资源管理器**拖拽文件**到此区域。
    *   **生成文件夹：** 为事件创建本地文件夹。
    *   **更新至文件夹：** 将选中的邮件附件保存到此本地文件夹。

---

## 报表导出 (Export Options)
通过主界面的“导出”按钮访问。此功能允许您将事件数据批量导出到本地文件系统。

*   **选择范围：**
    *   **选择模板：** 仅导出特定类型的事件（如仅导出“物流订单”）。
    *   **事件跨度：** 选择导出特定日期范围内的事件。
*   **导出内容：**
    *   **事件仪表盘数据表：** 导出 Excel/CSV 表格，包含所有提取的字段（如发票号、ETA等）。
    *   **事件附件区：** 导出邮件中的原始附件。
    *   **事件文件区：** 导出“文件区”中的本地文件。
*   **文件类型筛选：** 仅导出特定格式的文件（如仅导出 PDF 或 Excel）。
*   **文件夹命名：** 自定义导出文件夹的命名规则（如 `[日期]_[事件ID]`）。

---

## 配置：模板与配置编辑器
通过主窗口中的“模板编辑器”按钮访问。

### 1. 仪表盘模板
定义您想要跟踪的数据结构。
*   **字段：** 添加您想要提取的键（例如 "InvoiceNo", "ETA"）。
*   **正则：** 可选地将正则表达式绑定到字段以进行基于规则的提取。
*   **常用文件：** 为模板预设常用文件（如标准表格、清单）。配合“模板规则”自动分配模板时，这些文件会自动复制到事件的“文件区”，实现工作流文件的自动预准备。

### 2. Prompt 管理
管理发送给 LLM 的提示词。
*   **变量：** 使用 `{{MAIL_BODY}}` 或 `{{DASHBOARD_JSON}}` 等占位符注入动态上下文。
*   **关联：** 将 Prompt 链接到特定模板，使其仅出现在相关事件中。

### 3. 脚本管理
注册用于自动化的 Python 脚本。
*   **全局脚本：** 可以从主列表运行（例如“导出日报表”）。
*   **事件脚本：** 在特定事件内运行（例如“提取 PDF 数据”）。
*   **上下文：** 脚本接收包含所有事件数据（邮件、附件、仪表盘值）的 JSON 文件。

### 4. LLM 设置
配置您的 AI 提供商。
*   **提供方：** 支持 **Ollama 本地** 和 **HTTP API** (兼容 OpenAI 格式)。
*   **Ollama 模式：** 插件会自动获取本地已安装的 Ollama 模型列表供您选择。
*   **API 模式：** 支持自定义 Endpoint 和 API Key，可连接到任何兼容 OpenAI 接口的服务。
*   **作用范围：** 设置全局默认值或覆盖特定模板的设置。

### 5. 监听文件夹
默认情况下，OSEM 监控 `收件箱 (Inbox)` 和 `已发送邮件 (Sent Items)`。您可以在此处添加其他 Outlook 文件夹以将其邮件包含在事件分组中。

---

## 备份与迁移
位于模板编辑器的 **导出/导入** 选项卡中。
*   **导出备份：** 将您的所有设置（模板、Prompt、脚本、配置）和事件列表数据库保存为 `.zip` 文件。
*   **导入备份：** 从备份恢复数据。支持“合并模式”以解决现有数据与导入数据之间的冲突。

---

## 本地化
UI 语言会自动适应您的 Windows 系统语言。
*   **英语：** 默认。
*   **简体中文：** 在中文系统上自动激活。
